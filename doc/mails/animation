ＥｕｓＬｉｓｐを用いたアニメーションの作成　　　　　　1989-Apr-12

１．準備（起動とローディング）
　・Ｘwindowを用いる。eusxを走らせ、/usr/local/demo/x.l をロードする。
　・animation.l , manipulator.l をロードする。
　・(sys:newstack 128000) によって、大きめのスタックを確保する。
　・eta3armsol.oをロードする。
　・eta3build.l をロードする。eta3,eta4 のモデルが作られる。

２．姿勢の指定
　２つのマニピュレータの手先座標系と各関節角度は、クラスmanipulator と
そのサブクラスであるeta3arm で管理される（このほかに、eta2arm クラスが
ある）。eta3arm のインスタンスが、eta3a,eta4a の２つの変数にバインドさ
れている。これは、eta3build.l の中で次のようにして定義されている。
　  (setq eta4a
　　　　　(instance eta3arm  :create
　　　　　　　　　　:name 'eta4a
　　　　　　　　　　:hand eta46
　　　　　　　　　　:left-finger eta47  :right-finger eta48
　　　　　　　　　　:toolcoords eta4hand
　　　　　　　　　　:open-direction #f(0 1 0)
　　　　　　　　　　:joints (list eta41 eta42 eta43 eta44 eta45 eta46)
　　　　　　　　　　:base eta40
　　　　　　　　　　:right-handed nil)))
　クラスmanipulator はcascaded-coords のサブクラスであり、従って、他の
body等に結合できる。実際、baseの子供として登録される。
　eta3a,eta4a に対して:locate, :translate, :rotateなどのメッセージを送
ることにより、マニピュレータモデルを動かすことができる。wrt に、:world
, :local, などの指定をすることで任意の座標系で動作を指定できる。座標系
を変換した後、逆キネマを解いて関節角を求める。解が存在しない場合は座標
変換は取り消される。eta3の場合、１つの位置、姿勢に対して最大８種類の解
が求まるが、右手、左手の拘束（right-handed) と、直前のアーム解との連続
性から１つの解が選択される。
　座標系での指定以外に、各関節角度を指定することによって姿勢を定めるこ
とができる。６つの関節角を列にして、:angles メッセージを送る、または関
節の番号と角度を引数にして:angleメッセージを送る。いずれにしても、与え
られた関節角をもとに順キネマを計算し、最終的な位置・姿勢を表すcoordina
tes を求める。そこからさらに逆キネマが解かれ、各関節角度が定められるの
で、（計算誤差などにより）指定した角度と正確には一致しない。

３．表示
　表示にはdraw, hid 関数を用いる。変数eta3, eta4には全関節要素のリスト
が入れられているので、(hid eta3)などとする。
　動きを表示するには、各々の姿態でhid を実行し、あらかじめ線分要素を
すべて作成しておく、hid, draw の結果をpixmapに格納しておく、の２つの
方法がある。はウィンドウの大きさを変えたり、線分の太さを変えて表示す
る自由度が残る代わりに線分の数が増えると性能が低下する。は表示の属性
を変えられず、ファイル、メモリの消費も多いが表示は速い。。
　hid を行なうと*hid* 変数にedge-imageのリストがバインドされる。このリ
ストに対してlist-visible-segments を作用させると、すべての可視セグメン
トを同次座標表現したベクトル対のリストが得られる。このリストを多くのシ
ーンに対して生成し、それをリストにして、smooth-animationを呼ぶと、アニ
メーションが表示される。
　　(setq a (make-cube40 60 50))
    (setq s nil)
  　(dotimes (i 20)
　　　　　(send a :rotate -0.1 :x)
          (hid a)
          (push (list-visible-segments　*hid*) s))
    (smooth-animation s)
  pixmapに絵を生成するには、次のようにする。
　　(setq pix (make-xpixmaps 20 :size 500)) 　;pixmap リストを作る
　　(make-animation pix
　　　　　(send a :rotate -0.1 :x)  (hid a))  ;pixmap に絵を描く
　　(copy-pixmaps pix *viewsurface*)　　　　　;pixmap を順次表示する
